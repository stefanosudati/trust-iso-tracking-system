<!DOCTYPE html>
<html lang="it" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Trust ISO Tracking System</title>
  <meta name="description" content="Sistema di gestione certificazioni ISO per consulenti">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">

  <!-- Apple Touch Icon (Safari Add to Home Screen) -->
  <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-title" content="Trust ISO">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- Web App Manifest -->
  <link rel="manifest" href="/manifest.json">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif']
          }
        }
      }
    }
  </script>

  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>


  <style>
    /* ─── Theme CSS Variables (defaults = Blue) ─── */
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --primary-light: #dbeafe;
      --primary-lighter: #eff6ff;
      --primary-text: #1d4ed8;
      --primary-text-light: #2563eb;
      --primary-rgb: 37, 99, 235;
      --sidebar-bg: #ffffff;
      --sidebar-text: #475569;
      --sidebar-hover-bg: #f8fafc;
      --sidebar-active-bg: #eff6ff;
      --sidebar-active-text: #1d4ed8;
      --sidebar-active-icon: #2563eb;
      --sidebar-border: #e2e8f0;
      --sidebar-section: #64748b;
      --header-bg: #ffffff;
      --header-border: #e2e8f0;
      --body-bg: #f8fafc;
      --focus-border: #60a5fa;
      --focus-ring: rgba(59, 130, 246, 0.1);
      --badge-bg: #dbeafe;
      --badge-text: #1d4ed8;
      --progress-bar: #3b82f6;
      --chart-fill: rgba(37, 99, 235, 0.15);
      --chart-stroke: #2563eb;
      --app-title: #1e293b;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Smooth transitions */
    * { scroll-behavior: smooth; }

    /* Form styles */
    .form-label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 500;
      color: #475569;
      margin-bottom: 0.375rem;
    }
    .form-input {
      display: block;
      width: 100%;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      line-height: 1.5;
      color: #1e293b;
      background-color: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--focus-border);
      box-shadow: 0 0 0 3px var(--focus-ring);
    }
    select.form-input {
      appearance: auto;
    }
    textarea.form-input {
      resize: vertical;
    }

    /* Button styles */
    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: #fff;
      background-color: var(--primary);
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }
    .btn-primary:hover { background-color: var(--primary-hover); }

    .btn-secondary {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: #475569;
      background-color: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .btn-secondary:hover { background-color: #f8fafc; border-color: #cbd5e1; }

    .btn-danger {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: #fff;
      background-color: #dc2626;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }
    .btn-danger:hover { background-color: #b91c1c; }

    /* Sidebar transition */
    #sidebar {
      transition: transform 0.3s ease;
    }

    /* Status radio active animation */
    .status-radio {
      transition: all 0.2s ease;
    }
    .status-radio:hover {
      transform: translateY(-1px);
    }

    /* Themed checkbox accent */
    .themed-checkbox { accent-color: var(--primary); }

    /* ─── Mobile / iPhone fixes ─── */

    /* Prevent iOS zoom on input focus: inputs must be >= 16px */
    @media screen and (max-width: 767px) {
      .form-input,
      input.form-input,
      select.form-input,
      textarea.form-input,
      input[type="text"],
      input[type="email"],
      input[type="password"],
      input[type="tel"],
      input[type="date"],
      input[type="number"],
      input[type="search"],
      select,
      textarea {
        font-size: 16px !important;
      }
    }

    /* Safe area insets for notched iPhones */
    #header {
      padding-left: max(1rem, env(safe-area-inset-left));
      padding-right: max(1rem, env(safe-area-inset-right));
      padding-top: env(safe-area-inset-top);
    }

    #sidebar {
      padding-bottom: env(safe-area-inset-bottom);
    }

    #main-content {
      padding-bottom: env(safe-area-inset-bottom);
    }

    #toast-container {
      right: max(1rem, env(safe-area-inset-right));
    }

    /* Minimum touch target sizes (44x44px) for mobile */
    @media screen and (max-width: 767px) {
      .btn-primary,
      .btn-secondary,
      .btn-danger {
        min-height: 44px;
        padding: 0.625rem 1rem;
      }

      /* Icon-only buttons in header */
      #header button[class*="p-1"],
      #header button[class*="p-1.5"] {
        min-width: 44px;
        min-height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      /* Sidebar nav items */
      .sidebar-link {
        min-height: 44px;
        padding-top: 0.625rem;
        padding-bottom: 0.625rem;
      }

      /* Password toggle buttons */
      .pw-toggle {
        min-width: 44px;
        min-height: 44px;
      }
    }

    /* iOS Safari: smooth momentum scrolling */
    #sidebar,
    #main-content,
    .overflow-y-auto,
    .overflow-x-auto {
      -webkit-overflow-scrolling: touch;
    }

    /* Prevent content shift when iOS Safari address bar shows/hides */
    @supports (height: 100dvh) {
      html, body, .h-full {
        height: 100dvh;
      }
    }

    /* Mobile: sidebar adjustments */
    @media screen and (max-width: 1023px) {
      /* Ensure sidebar fills height properly below header,
         accounting for safe-area-inset-top on the header */
      #sidebar {
        top: 0;
        height: 100%;
        padding-top: calc(5rem + env(safe-area-inset-top));
      }

      /* When sidebar opens, prevent body scrolling */
      body.sidebar-open {
        overflow: hidden;
      }
    }

    /* Horizontal scroll hint for tables on mobile */
    @media screen and (max-width: 767px) {
      .overflow-x-auto {
        position: relative;
      }
      .overflow-x-auto::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 24px;
        background: linear-gradient(to right, transparent, rgba(255,255,255,0.8));
        pointer-events: none;
        opacity: 1;
        transition: opacity 0.3s;
      }
      .overflow-x-auto:not([data-scrolled="false"])::after {
        opacity: 0;
      }

      /* Tables: prevent cell content wrapping making cells too wide */
      table th, table td {
        white-space: nowrap;
      }
    }

    /* Modal: safe area padding on mobile */
    @media screen and (max-width: 767px) {
      #modal > .relative {
        max-height: calc(90vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
        margin: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
      }
    }

    /* Print styles */
    @media print {
      #sidebar, #header, #toast-container { display: none !important; }
      #main-content { margin-left: 0 !important; }
    }
    /* Password toggle button */
    .pw-toggle {
      position: absolute;
      right: 0.625rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: #94a3b8;
      padding: 0.25rem;
      display: flex;
      align-items: center;
    }
    .pw-toggle:hover { color: #475569; }
  </style>

  <script>
    function togglePw(btn) {
      var input = btn.parentElement.querySelector('input');
      var isPassword = input.type === 'password';
      input.type = isPassword ? 'text' : 'password';
      var icon = btn.querySelector('i');
      if (icon) icon.setAttribute('data-lucide', isPassword ? 'eye-off' : 'eye');
      if (window.lucide) lucide.createIcons();
    }
  </script>

  <!-- Anti-FOUC: apply saved theme before body renders -->
  <script>
    (function(){
      try {
        var t = localStorage.getItem('trust_iso_theme');
        if (t && t !== 'default') {
          var v = localStorage.getItem('trust_iso_theme_vars');
          if (v) { var o = JSON.parse(v), r = document.documentElement; for (var k in o) r.style.setProperty(k, o[k]); }
        }
      } catch(e){}
    })();
  </script>
</head>
<body class="h-full font-sans antialiased" style="background-color: var(--body-bg);">
  <div class="h-full flex flex-col">

    <!-- Header -->
    <header id="header" class="px-4 h-20 flex items-center justify-between flex-shrink-0 z-30 relative" style="background-color: var(--header-bg); border-bottom: 1px solid var(--header-border);">
      <div class="flex items-center gap-3 min-w-0">
        <!-- Mobile menu toggle -->
        <button id="toggle-sidebar" class="lg:hidden p-1.5 rounded-lg hover:bg-slate-100 text-slate-600">
          <i data-lucide="menu" class="w-5 h-5"></i>
        </button>

        <!-- Logo (clickable → go to overview) -->
        <div class="flex items-center gap-2 cursor-pointer" title="Torna alla panoramica">
          <img src="/img/logo.png" alt="Trust ISO" class="w-16 h-16 object-contain">
          <span class="font-bold hidden sm:block" style="color: var(--app-title);">Trust ISO Tracking System</span>
        </div>

        <!-- Active project info (hidden on very small screens to prevent overflow) -->
        <div id="header-project-info" class="hidden items-center gap-2 ml-4 pl-4 border-l border-slate-200 max-sm:!hidden">
          <span id="header-project-name" class="text-sm font-medium text-slate-700 truncate max-w-[120px] sm:max-w-[200px]"></span>
          <span id="header-phase" class="text-xs px-2 py-0.5 rounded-full whitespace-nowrap"></span>
        </div>
      </div>

      <div class="flex items-center gap-3 flex-shrink-0">
        <!-- Search -->
        <div class="relative hidden md:block">
          <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
          <input id="quick-search" type="text" placeholder="Cerca requisito..."
                 class="pl-9 pr-3 py-1.5 text-sm border border-slate-200 rounded-lg w-56 focus:outline-none" style="--tw-ring-color: var(--focus-ring);" onfocus="this.style.borderColor='var(--focus-border)';this.style.boxShadow='0 0 0 2px var(--focus-ring)'" onblur="this.style.borderColor='';this.style.boxShadow=''">
          <div id="search-results" class="hidden absolute top-full left-0 right-0 mt-1 bg-white rounded-lg shadow-lg border border-slate-200 max-h-64 overflow-y-auto z-50"></div>
        </div>

        <!-- Auto-save indicator -->
        <span id="autosave-indicator" class="text-xs text-emerald-600 opacity-0 transition-opacity">Salvato</span>

        <!-- Actions -->
        <button id="btn-export" class="p-1.5 rounded-lg hover:bg-slate-100 text-slate-500" title="Esporta dati">
          <i data-lucide="download" class="w-4 h-4"></i>
        </button>
        <button id="btn-import" class="p-1.5 rounded-lg hover:bg-slate-100 text-slate-500" title="Importa dati">
          <i data-lucide="upload" class="w-4 h-4"></i>
        </button>

        <!-- User menu -->
        <div class="hidden items-center gap-2 ml-2 pl-2 border-l border-slate-200" id="user-menu">
          <span id="user-name-display" class="text-xs text-slate-500 hidden sm:block"></span>
          <button id="btn-logout" class="p-1.5 rounded-lg hover:bg-red-50 text-slate-500 hover:text-red-600 transition-colors" title="Esci">
            <i data-lucide="log-out" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 flex overflow-hidden relative">

      <!-- Sidebar overlay (mobile) -->
      <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/30 z-[35] lg:hidden"></div>

      <!-- Sidebar -->
      <aside id="sidebar" class="w-64 flex-shrink-0 overflow-y-auto z-40
                                  fixed lg:static inset-y-0 left-0 -translate-x-full lg:translate-x-0"
             style="background-color: var(--sidebar-bg); border-right: 1px solid var(--sidebar-border);">
        <div class="p-3 space-y-1">
          <nav id="sidebar-nav">
            <!-- Populated by JS -->
          </nav>
        </div>
      </aside>

      <!-- Main Content -->
      <main id="main-content" class="flex-1 overflow-y-auto">
        <!-- Populated by JS -->
      </main>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-16 right-4 z-50 flex flex-col items-end"></div>

  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="modal-backdrop absolute inset-0 bg-black/40"></div>
    <div class="relative bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[80vh] overflow-y-auto">
      <div class="p-5">
        <h2 id="modal-title" class="text-lg font-semibold text-slate-800 mb-4"></h2>
        <div id="modal-body"></div>
        <div id="modal-actions" class="mt-4"></div>
      </div>
    </div>
  </div>

  <!-- Scripts (order matters: data -> core -> view modules -> facade -> export -> app) -->
  <script src="data/iso9001.js"></script>

  <!-- Shared constants -->
  <script src="js/constants.js"></script>

  <!-- Core -->
  <script src="js/api-client.js"></script>
  <script src="js/themes.js"></script>
  <script src="js/auth.js"></script>

  <!-- View modules -->
  <script src="js/views/dashboard-view.js"></script>
  <script src="js/views/projects-view.js"></script>
  <script src="js/views/project-detail-view.js"></script>
  <script src="js/views/clause-view.js"></script>
  <script src="js/views/requirement-view.js"></script>
  <script src="js/views/documents-view.js"></script>
  <script src="js/views/timeline-view.js"></script>
  <script src="js/views/reports-view.js"></script>
  <script src="js/views/settings-view.js"></script>
  <script src="js/views/clients-view.js"></script>
  <script src="js/views/admin-view.js"></script>

  <!-- Views facade (backward compat) -->
  <script src="js/views.js"></script>

  <!-- Markdown export -->
  <script src="js/md-export.js"></script>
  <script src="js/report-export.js"></script>

  <!-- Tutorial (first-login onboarding) -->
  <script src="js/tutorial.js"></script>

  <!-- Main app -->
  <script src="js/app.js"></script>
</body>
</html>
